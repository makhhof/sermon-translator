<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Translation (Projector View)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 3rem;
            background: #000;
            color: #FFF;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
        }
        #translation-container {
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 10px;
        }
        .translation-line {
            line-height: 1.5;
            margin-bottom: 1rem;
            text-align: right;
            word-wrap: break-word;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s forwards;
        }
        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-cursor::after {
            content: '|';
            animation: blink-caret 0.75s step-end infinite;
        }
        @keyframes blink-caret {
            from, to { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="translation-container"></div>

    <script>
        // Configuration
        const TYPING_SPEED = 30; // Milliseconds per character
        const MAX_LINES = 5;     // Max number of lines to keep
        // IMPORTANT: Update this to point to your Node.js WebSocket server
const WS_URL = window.location.hostname.includes('onrender.com') 
    ? `wss://${window.location.hostname}`
    : `ws://${window.location.hostname}:${window.location.port || 3000}`;
        // State variables
        let currentLine = null;
        let typingInterval = null;
        let previousTranslations = [];
        const container = document.getElementById('translation-container');

        // WebSocket connection
        const ws = new WebSocket(WS_URL);

        ws.onopen = () => {
            console.log('Connected to WebSocket server');
            fetchInitialTranslation();
        };

        ws.onmessage = (event) => {
            const newTranslation = event.data;
            if (newTranslation && newTranslation.trim() !== "") {
                startTypingAnimation(newTranslation);
            }
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected. Reconnecting...');
            // The original code reloads the page, which is fine for simplicity
            setTimeout(() => window.location.reload(), 3000);
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        // Fetch initial translation if available from the Node.js server
        function fetchInitialTranslation() {
            // IMPORTANT: Update this to point to your Node.js HTTP server
            fetch('/get_translation') // Changed from 'get_translation.php'
                .then(response => response.text())
                .then(text => {
                    if (text && text.trim() !== "" && text.trim() !== 'در حال انتظار برای ترجمه...') {
                        addCompletedLine(text.trim());
                    }
                })
                .catch(error => console.error('Error fetching initial translation:', error));
        }

        // Start typing animation for new text
        function startTypingAnimation(text) {
            // Clear any existing typing animation
            if (typingInterval) {
                clearInterval(typingInterval);
                if (currentLine) {
                    currentLine.classList.remove('typing-cursor');
                }
            }

            // Create new line element
            currentLine = document.createElement('div');
            currentLine.className = 'translation-line typing-cursor';
            container.appendChild(currentLine);

            // Start typing animation
            let charIndex = 0;
            typingInterval = setInterval(() => {
                if (charIndex < text.length) {
                    currentLine.textContent += text.charAt(charIndex);
                    charIndex++;
                    // Auto-scroll to keep visible
                    currentLine.scrollIntoView({ behavior: 'smooth', block: 'end' });
                } else {
                    completeCurrentLine(text);
                }
            }, TYPING_SPEED);
        }

        // Complete the current line animation
        function completeCurrentLine(text) {
            if (typingInterval) {
                clearInterval(typingInterval);
                typingInterval = null;
            }

            if (currentLine) {
                currentLine.textContent = text;
                currentLine.classList.remove('typing-cursor');
                currentLine = null;
            }

            // Add to history and manage line count
            if (text && !previousTranslations.includes(text)) {
                previousTranslations.push(text);
                if (previousTranslations.length > MAX_LINES) {
                    container.removeChild(container.firstChild);
                    previousTranslations.shift();
                }
            }
        }

        // Add a completed line (for initial load)
        function addCompletedLine(text) {
            const line = document.createElement('div');
            line.className = 'translation-line';
            line.textContent = text;
            container.appendChild(line);

            if (!previousTranslations.includes(text)) {
                previousTranslations.push(text);
                if (previousTranslations.length > MAX_LINES) {
                    container.removeChild(container.firstChild);
                    previousTranslations.shift();
                }
            }

            line.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    </script>
</body>

</html>
